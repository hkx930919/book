---
sidebarDepth: 2
---

# 浏览器工作原理

## 宏观视角下的浏览器

### 1.1 chrome 架构

#### 进程和线程

**并行处理：**计算机中的并行处理就是同一时刻处理多个任务

> 有多个任务要处理时，正常情况下程序可以使用单线程来处理，也就是分步按照顺序分别执行这些任务。如果采用多线程，多个线程同
> 时执行这些任务；使用并行处理能大大提升性能

- 线程不能单独存在，它是由进程进行启动和管理，线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率

- 一个进程就是一个程序的运行实例。启动一个程序的时候，操作系统会为该 程序创建一块内存，用来存放代码、运行中的数据和一个
  执行任务的主线程，我们把这样的 一个运行环境叫进程
- 进程中的任意一线程执行出错，都会导致整个进程的崩溃
- 线程之间共享进程中的数据
- 当一个进程关闭之后，操作系统会回收进程所占用的内存
- 进程之间的内容相互隔离。一个进程挂了不会影响到别的进程，进程与进程之前使用 IPC 进行通信

#### 单进程浏览器时代

> 单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程里，这些模块包含了网络、插件、 JavaScript 运行环境、渲染引擎和
> 页面等。

如此多的功能模块运行在一个进程里，是导致单进程浏览器不稳定、不流畅和不安全的一个主要因素

- **不稳定：**线程的崩溃导致进程的崩溃，进而整个浏览器崩溃
  - 插件的崩溃导致整个浏览器的崩溃
  - 渲染引擎模块也是不稳定的，一些复杂的 JavaScript 代码就有可能引起渲染引擎模块的崩溃，进而导致浏览器崩溃
- **不流畅：**所有页面的渲染模块、JavaScript 执行 环境以及插件都是运行在同一个线程中的，这就意味着同一时刻只能有一个模块
  可以执行，js 会阻塞其他模块的进行
- **不安全：**插件可以使用 C/C++ 等代码编写，通过插件可以获取到操作系统的任意资源，当你在页面 运行一个插件时也就意味着这
  个插件能完全操作你的电脑。如果是个恶意插件，那么它就可 以释放病毒、窃取你的账号密码，引发安全性问题

#### 多进程浏览器时代

##### 早期多进程架构

![早期 Chrome 进程架构图 ](https://static001.geekbang.org/resource/image/cd/60/cdc9215e6c6377fc965b7fac8c3ec960.png)
<br/>包含渲染进程、插件进程、浏览器主进程，每个 tab 页和一个插件就是一个新的进程

- **不稳定解决方案：**由于进程是相互隔离的，所以当一个页面或者插件崩溃 时，影响到的仅仅是当前的页面进程或者插件进程，并
  不会影响到浏览器和其他页面，这就 完美地解决了页面或者插件的崩溃会导致整个浏览器崩溃
- **不流畅解决方案：**
  - 同样，JavaScript 也是运行在渲染进程中 的，所以即使 JavaScript 阻塞了渲染进程，影响到的也只是当前的渲染页面，而并不会
    影响浏览器其他页面，因为其他页面的脚本是运行在它们自己的渲染进程中的。
  - 当关闭一个页面时，整个渲染进程也会被关 闭，之后该进程所占用的内存都会被系统回收，这样就轻松解决了浏览器页面的内存 泄
    漏问题。
- **不安全解决方案：**对插件进程和渲染进程使用**安全沙箱**，可以把沙箱看成是操作系统给进程上了一把锁，沙箱里面的程序可以
  运行， 但是不能在你的硬盘上写入任何数据，也不能在敏感位置读取任何数据，这样即使在渲染进程或者插件进程里 面执行了恶意程
  序，恶意程序也无法突破沙箱去获取系统权限。

##### 目前多进程架构

![目前多进程架构 ](https://static001.geekbang.org/resource/image/b6/fc/b61cab529fa31301bde290813b4587fc.png) <br/>在之前
的基础上增加了 GPU 进程和网络进程。

- **浏览器主进程。**主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。
- **渲染进程。**核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8
  都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。
- **GPU 进程。**Chrome 刚开始发布的时候是没有 GPU 进程的。而 GPU 的使用初衷是为了实现 3D CSS 的效果，只是随后网页
  、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求。最后，Chrome 在其多进程架构上也引入了 GPU
  进程。
- **网络进程。**主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的
  进程。负责 url 的请求，ajax 的请求等等
- **插件进程进程。**主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面
  造成影响。

  所以打开一个页面，至少会开启浏览器主进程、渲染进程、GPU 进程、网络进程这四个进程，如果装了插件，那么每个插件都算一个进
  程。

<br/>多进程也有一些弊端：

- **更高的资源占用：**因为每个进程都会包含公共基础结构的副本（如 JavaScript 运行环境），这就意味着浏览器会消耗更多的内存
  资源。
- **更复杂的体系架构：**浏览器各模块之间耦合性高、扩展性差等问题，会导致现在的架构已经很难适应新的需求了。

##### 未来面向服务的架构

为了解决这些问题，在 2016 年，Chrome 官方团队使用“面向服务的架构”（Services Oriented Architecture，简称 SOA）的思想设计
了新的 Chrome 架构。也就是说 Chrome 整体架构会朝向现代操作系统所采用的“面向服务的架构” 方向发展，原来的各种模块会被重构
成独立的服务（Service），每个服务（Service）都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC
来通信，从而构建一个**更内聚、松耦合、易于维护和扩展的系统**，更好实现 Chrome 简单、稳定、高速、安全的目标。
![未来面向服务的架构 ](https://static001.geekbang.org/resource/image/32/2a/329658fe821252db47b0964037a1de2a.png)

#### TIPS

- Q:为什么还会碰到一些由于单个页面卡死最终崩溃导致所有页面崩溃的情况？

```
有一种情况，叫"同一站点(same-site)"，具体地讲，我们将“同一站点”定义为根域名（例如，geekbang.org）加上协议（例如，https:// 或者http://），还包含了该根域名下的所有子域名和不同的端口，比如下面这三个：
https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080
都是属于同一站点，因为它们的协议都是https，而根域名也都是geekbang.org。

Chrome的默认策略是，每个标签对应一个渲染进程。但是如果从一个页面打开了新页面，而新页面和当前页面属于同一站点时，那么新页面会复用父页面的渲染进程。官方把这个默认策略叫process-per-site-instance。即统一站点的页面共用一个渲染进程。

为什么要让他们跑在一个进程里面呢？
因为在一个渲染进程里面，他们就会共享JS的执行环境，也就是说A页面可以直接在B页面中执行脚本。因为是同一家的站点，所以是有这个需求的。
```

- Q:为什么打开一个页面后没有插件也不只四个进程？

```
如果页面里有iframe的话，iframe也会运行在单独的进程中！
```

- Q:Chrome 排版引擎现在是 blink，这一点从哪里可以看到呢？在 76 版本 Chrome 的 navigator 属性值里只看到了 AppleWebkit，这
  是为什么？

```
UserAgent，又称为UA，UA是浏览器的身份证，通常，在发送HTTP请求时，UA会附带在HTTP的请求头中user-agent字段中，这样服务器就会知道浏览器的基础信息，然后服务器会根据不同的UA返回不同的页面内容，比如手机上返回手机的样式，PC就返回PC的样式。

服务器会根据不同的UA来针性的设计不同页面，所以当出了一款新浏览器时，他如果使用自己独一无二的UA，那么之前的很多服务器还需要针对他来做页面适配，这显然是不可能的，比如Chrome发布时他会在他的UA中使用“Mozilla” ，“AppleWebKit”，等关键字段，用来表示他同时支持Mozilla和AppleWebKit，然后再在最后加上他自己的标示，如Chrome/xxx。

这就解释了为什么查看的信息中含有WebKit字样。
```

- 安全沙箱是不能应用到浏览器主进程之上的，因为浏览器主进程需要对操作系统的权限
